name: Multi-Site Deployment

on:
  push:
    branches: [master, main]
  workflow_dispatch:
    inputs:
      site_id:
        description: 'Specific site ID to deploy (leave empty for all)'
        required: false
        type: string
  repository_dispatch:
    types: [site_created]

jobs:
  fetch-configs:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - name: Fetch site configurations from Appwrite
        id: set-matrix
        run: |
          # Fetch all site configs from Appwrite database
          CONFIGS=$(curl -X GET \
            "https://fra.cloud.appwrite.io/v1/databases/${{ secrets.APPWRITE_DATABASE_ID }}/collections/deployment_configs/documents" \
            -H "X-Appwrite-Project: ${{ secrets.APPWRITE_PROJECT_ID }}" \
            -H "X-Appwrite-Key: ${{ secrets.APPWRITE_API_KEY }}" \
            -H "Content-Type: application/json")
          
          # Extract documents and format for matrix
          MATRIX=$(echo "$CONFIGS" | jq -c '{include: [.documents[] | {siteId: .siteId, siteName: .siteName, appId: .appId, primaryColor: .primaryColor, secondaryColor: .secondaryColor, domain: .domain}]}')
          
          echo "matrix=$MATRIX" >> $GITHUB_OUTPUT
          echo "Found sites to deploy:"
          echo "$MATRIX" | jq '.'

  build-and-deploy:
    needs: fetch-configs
    runs-on: ubuntu-latest
    strategy:
      matrix: ${{fromJson(needs.fetch-configs.outputs.matrix)}}
      fail-fast: false
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build site - ${{ matrix.siteName }}
        env:
          APP_ID: ${{ matrix.appId }}
          PRIMARY_COLOR: ${{ matrix.primaryColor }}
          SECONDARY_COLOR: ${{ matrix.secondaryColor }}
          SITE_NAME: ${{ matrix.siteName }}
          DOMAIN: ${{ matrix.domain }}
        run: |
          echo "Building ${{ matrix.siteName }} with App ID: ${{ matrix.appId }}"
          npm run build

      - name: Create or Verify Appwrite Hosting Site - ${{ matrix.siteName }}
        id: create-site
        run: |
          echo "üîç Checking if site '${{ matrix.siteName }}' exists in Appwrite Hosting..."
          
          # Check if site exists by listing all sites
          EXISTING_SITES=$(curl -s -X GET \
            "https://fra.cloud.appwrite.io/v1/hosting/sites" \
            -H "X-Appwrite-Project: ${{ secrets.APPWRITE_PROJECT_ID }}" \
            -H "X-Appwrite-Key: ${{ secrets.APPWRITE_API_KEY }}" \
            -H "Content-Type: application/json" || echo '{"sites":[]}')
          
          # Check if site with this name exists
          SITE_EXISTS=$(echo "$EXISTING_SITES" | jq -r --arg name "${{ matrix.siteName }}" '.sites[]? | select(.name == $name) | .$id' || echo "")
          
          if [ -z "$SITE_EXISTS" ]; then
            echo "üì¶ Site '${{ matrix.siteName }}' not found. Creating new site..."
            
            # Create site via Appwrite Hosting API
            CREATE_RESPONSE=$(curl -s -X POST \
              "https://fra.cloud.appwrite.io/v1/hosting/sites" \
              -H "X-Appwrite-Project: ${{ secrets.APPWRITE_PROJECT_ID }}" \
              -H "X-Appwrite-Key: ${{ secrets.APPWRITE_API_KEY }}" \
              -H "Content-Type: application/json" \
              -d "{\"name\": \"${{ matrix.siteName }}\"}" || echo '{"error":"failed"}')
            
            # Extract site ID from response
            NEW_SITE_ID=$(echo "$CREATE_RESPONSE" | jq -r '.["$id"] // .id // empty' || echo "")
            
            if [ -n "$NEW_SITE_ID" ] && [ "$NEW_SITE_ID" != "null" ]; then
              echo "‚úÖ Site created successfully with ID: $NEW_SITE_ID"
              echo "APPWRITE_SITE_ID=$NEW_SITE_ID" >> $GITHUB_ENV
              
              # Update database with the actual Appwrite Site ID
              curl -s -X PUT \
                "https://fra.cloud.appwrite.io/v1/databases/${{ secrets.APPWRITE_DATABASE_ID }}/collections/deployment_configs/documents/${{ matrix.siteId }}" \
                -H "X-Appwrite-Project: ${{ secrets.APPWRITE_PROJECT_ID }}" \
                -H "X-Appwrite-Key: ${{ secrets.APPWRITE_API_KEY }}" \
                -H "Content-Type: application/json" \
                -d "{\"siteId\": \"$NEW_SITE_ID\", \"status\": \"created\", \"updatedAt\": \"$(date -u +"%Y-%m-%dT%H:%M:%SZ")\"}" || echo "‚ö†Ô∏è Could not update database"
            else
              echo "‚ö†Ô∏è Site creation via API failed. Response: $CREATE_RESPONSE"
              echo "‚ö†Ô∏è You may need to create the site manually in Appwrite Console ‚Üí Sites"
              echo "‚ö†Ô∏è Then update the config with the Site ID"
              echo "APPWRITE_SITE_ID=${{ matrix.siteId }}" >> $GITHUB_ENV
            fi
          else
            echo "‚úÖ Site '${{ matrix.siteName }}' already exists with ID: $SITE_EXISTS"
            echo "APPWRITE_SITE_ID=$SITE_EXISTS" >> $GITHUB_ENV
            
            # Update database with the actual Appwrite Site ID if different
            if [ "$SITE_EXISTS" != "${{ matrix.siteId }}" ]; then
              curl -s -X PUT \
                "https://fra.cloud.appwrite.io/v1/databases/${{ secrets.APPWRITE_DATABASE_ID }}/collections/deployment_configs/documents/${{ matrix.siteId }}" \
                -H "X-Appwrite-Project: ${{ secrets.APPWRITE_PROJECT_ID }}" \
                -H "X-Appwrite-Key: ${{ secrets.APPWRITE_API_KEY }}" \
                -H "Content-Type: application/json" \
                -d "{\"siteId\": \"$SITE_EXISTS\", \"status\": \"created\", \"updatedAt\": \"$(date -u +"%Y-%m-%dT%H:%M:%SZ")\"}" || echo "‚ö†Ô∏è Could not update database"
            fi
          fi
          
          echo "üöÄ App ID: ${{ matrix.appId }}"
          echo "üé® Colors: ${{ matrix.primaryColor }} / ${{ matrix.secondaryColor }}"

      - name: Deploy to Appwrite Hosting - ${{ matrix.siteName }}
        if: env.APPWRITE_SITE_ID != ''
        run: |
          echo "üöÄ Deploying ${{ matrix.siteName }} to Appwrite Hosting..."
          
          # Install Appwrite CLI for deployment
          npm install -g appwrite-cli@latest
          
          # Login to Appwrite
          appwrite client --endpoint https://fra.cloud.appwrite.io/v1 --project "${{ secrets.APPWRITE_PROJECT_ID }}" --key "${{ secrets.APPWRITE_API_KEY }}"
          
          # Deploy to Appwrite Hosting
          appwrite deploy hosting \
            --siteId "${{ env.APPWRITE_SITE_ID }}" \
            --project "${{ secrets.APPWRITE_PROJECT_ID }}" \
            --key "${{ secrets.APPWRITE_API_KEY }}" \
            --dist "dist" || echo "‚ö†Ô∏è Deployment failed - check Appwrite Console"
          
          echo "‚úÖ Deployment completed for ${{ matrix.siteName }}"
          
          # Update status in database
          curl -s -X PUT \
            "https://fra.cloud.appwrite.io/v1/databases/${{ secrets.APPWRITE_DATABASE_ID }}/collections/deployment_configs/documents/${{ matrix.siteId }}" \
            -H "X-Appwrite-Project: ${{ secrets.APPWRITE_PROJECT_ID }}" \
            -H "X-Appwrite-Key: ${{ secrets.APPWRITE_API_KEY }}" \
            -H "Content-Type: application/json" \
            -d "{\"status\": \"deployed\", \"updatedAt\": \"$(date -u +"%Y-%m-%dT%H:%M:%SZ")\"}" || echo "‚ö†Ô∏è Could not update status"

      - name: Upload build artifact
        uses: actions/upload-artifact@v3
        with:
          name: site-${{ matrix.siteId }}
          path: dist/
          retention-days: 7

  notify-completion:
    needs: build-and-deploy
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Deployment Summary
        run: |
          echo "üéâ Multi-site deployment completed!"
          echo "Check the artifacts for each site build"
